{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import { PureComponent } from 'react'\nimport PropTypes from 'prop-types'\nimport MapboxGeocoder from '@mapbox/mapbox-gl-geocoder'\nimport { FlyToInterpolator } from 'react-map-gl'\nimport WebMercatorViewport from 'viewport-mercator-project'\nimport mapboxgl from 'mapbox-gl'\n\nconst VALID_POSITIONS = ['top-left', 'top-right', 'bottom-left', 'bottom-right']\n\nclass Geocoder extends PureComponent {\n  geocoder = null\n  cachedResult = null\n\n  componentDidMount() {\n    this.initializeGeocoder()\n  }\n\n  componentWillUnmount() {\n    this.removeGeocoder()\n  }\n\n  componentDidUpdate() {\n    this.removeGeocoder()\n    this.initializeGeocoder()\n  }\n\n  initializeGeocoder = () => {\n    const mapboxMap = this.getMapboxMap()\n    const containerNode = this.getContainerNode()\n    const {\n      mapboxApiAccessToken,\n      inputValue,\n      origin,\n      zoom,\n      placeholder,\n      proximity,\n      trackProximity,\n      collapsed,\n      clearAndBlurOnEsc,\n      clearOnBlur,\n      bbox,\n      types,\n      countries,\n      minLength,\n      limit,\n      language,\n      filter,\n      localGeocoder,\n      reverseGeocode,\n      enableEventLogging,\n      marker,\n      render,\n      getItemValue,\n      onInit,\n      position\n    } = this.props\n    const options = {\n      accessToken: mapboxApiAccessToken,\n      origin,\n      zoom,\n      flyTo: false,\n      placeholder,\n      proximity,\n      trackProximity,\n      collapsed,\n      clearAndBlurOnEsc,\n      clearOnBlur,\n      bbox,\n      types,\n      countries,\n      minLength,\n      limit,\n      language,\n      filter,\n      localGeocoder,\n      reverseGeocode,\n      enableEventLogging,\n      marker,\n      mapboxgl\n    }\n\n    if (render && typeof render === 'function') {\n      options.render = render\n    }\n\n    if (getItemValue && typeof getItemValue === 'function') {\n      options.getItemValue = getItemValue\n    }\n\n    this.geocoder = new MapboxGeocoder(options)\n    this.subscribeEvents()\n\n    if (containerNode) {\n      containerNode.appendChild(this.geocoder.onAdd(mapboxMap))\n    } else {\n      mapboxMap.addControl(this.geocoder, VALID_POSITIONS.find((_position) => position === _position))\n    }\n\n    if (inputValue !== undefined && inputValue !== null) {\n      this.geocoder.setInput(inputValue)\n    } else if (this.cachedResult) {\n      this.geocoder.setInput(this.cachedResult.place_name)\n    }\n\n    if (this.cachedResult || (inputValue !== undefined && inputValue !== null)) {\n      this.showClearIcon()\n    }\n\n    onInit(this.geocoder)\n  }\n\n  showClearIcon = () => {\n    // this is a hack to force clear icon to show if there is text in the input\n    this.geocoder._clearEl.style.display = 'block'\n  }\n\n  getMapboxMap = () => {\n    const { mapRef } = this.props\n\n    return (mapRef && mapRef.current && mapRef.current.getMap()) || null\n  }\n\n  getContainerNode = () => {\n    const { containerRef } = this.props\n\n    return (containerRef && containerRef.current) || null\n  }\n\n  subscribeEvents = () => {\n    this.geocoder.on('clear', this.handleClear)\n    this.geocoder.on('loading', this.handleLoading)\n    this.geocoder.on('results', this.handleResults)\n    this.geocoder.on('result', this.handleResult)\n    this.geocoder.on('error', this.handleError)\n  }\n\n  unsubscribeEvents = () => {\n    this.geocoder.off('clear', this.handleClear)\n    this.geocoder.off('loading', this.handleLoading)\n    this.geocoder.off('results', this.handleResults)\n    this.geocoder.off('result', this.handleResult)\n    this.geocoder.off('error', this.handleError)\n  }\n\n  removeGeocoder = () => {\n    const mapboxMap = this.getMapboxMap()\n\n    this.unsubscribeEvents()\n\n    if (mapboxMap && mapboxMap.removeControl) {\n      this.getMapboxMap().removeControl(this.geocoder)\n    }\n\n    this.geocoder = null\n  }\n\n  handleClear = () => {\n    this.cachedResult = null\n    this.props.onClear()\n  }\n\n  handleLoading = (event) => {\n    this.props.onLoading(event)\n  }\n\n  handleResults = (event) => {\n    this.props.onResults(event)\n  }\n\n  handleResult = (event) => {\n    const { result } = event\n    const { onViewportChange, onResult } = this.props\n    const { bbox, center, properties = {} } = result\n    const { short_code } = properties\n    const [longitude, latitude] = center\n    const bboxExceptions = {\n      fr: {\n        name: 'France',\n        bbox: [[-4.59235, 41.380007], [9.560016, 51.148506]]\n      },\n      us: {\n        name: 'United States',\n        bbox: [[-171.791111, 18.91619], [-66.96466, 71.357764]]\n      },\n      ru: {\n        name: 'Russia',\n        bbox: [[19.66064, 41.151416], [190.10042, 81.2504]]\n      },\n      ca: {\n        name: 'Canada',\n        bbox: [[-140.99778, 41.675105], [-52.648099, 83.23324]]\n      }\n    }\n    const { width, height } = this.getMapboxMap()\n      .getContainer()\n      .getBoundingClientRect()\n    let zoom = this.geocoder.options.zoom\n    const fitBounds = (bounds, viewport) => new WebMercatorViewport(viewport).fitBounds(bounds)\n\n    try {\n      if (!bboxExceptions[short_code] && bbox) {\n        zoom = fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], { width, height }).zoom\n      } else if (bboxExceptions[short_code]) {\n        zoom = fitBounds(bboxExceptions[short_code].bbox, { width, height }).zoom\n      }\n    } catch (e) {\n      console.warn('following result caused an error when trying to zoom to bbox: ', result) // eslint-disable-line\n      zoom = this.geocoder.options.zoom\n    }\n\n    onViewportChange({\n      longitude,\n      latitude,\n      zoom,\n      transitionInterpolator: new FlyToInterpolator(),\n      transitionDuration: 3000\n    })\n    onResult(event)\n\n    this.cachedResult = result\n    this.geocoder._typeahead.selected = null\n    this.showClearIcon()\n  }\n\n  handleError = (event) => {\n    this.props.onError(event)\n  }\n\n  getGeocoder() {\n    return this.geocoder\n  }\n\n  render() {\n    return null\n  }\n\n  static propTypes = {\n    mapRef: PropTypes.object.isRequired,\n    containerRef: PropTypes.object,\n    onViewportChange: PropTypes.func,\n    mapboxApiAccessToken: PropTypes.string.isRequired,\n    inputValue: PropTypes.string,\n    origin: PropTypes.string,\n    zoom: PropTypes.number,\n    placeholder: PropTypes.string,\n    proximity: PropTypes.object,\n    trackProximity: PropTypes.bool,\n    collapsed: PropTypes.bool,\n    clearAndBlurOnEsc: PropTypes.bool,\n    clearOnBlur: PropTypes.bool,\n    bbox: PropTypes.array,\n    types: PropTypes.string,\n    countries: PropTypes.string,\n    minLength: PropTypes.number,\n    limit: PropTypes.number,\n    language: PropTypes.string,\n    filter: PropTypes.func,\n    localGeocoder: PropTypes.func,\n    reverseGeocode: PropTypes.bool,\n    enableEventLogging: PropTypes.bool,\n    marker: PropTypes.bool,\n    render: PropTypes.func,\n    getItemValue: PropTypes.func,\n    position: PropTypes.oneOf(VALID_POSITIONS),\n    onInit: PropTypes.func,\n    onClear: PropTypes.func,\n    onLoading: PropTypes.func,\n    onResults: PropTypes.func,\n    onResult: PropTypes.func,\n    onError: PropTypes.func\n  }\n\n  static defaultProps = {\n    onViewportChange: () => {},\n    origin: 'https://api.mapbox.com',\n    zoom: 16,\n    placeholder: 'Search',\n    trackProximity: false,\n    collapsed: false,\n    clearAndBlurOnEsc: false,\n    clearOnBlur: false,\n    minLength: 2,\n    limit: 5,\n    reverseGeocode: false,\n    enableEventLogging: true,\n    marker: true,\n    position: 'top-right',\n    onInit: () => {},\n    onClear: () => {},\n    onLoading: () => {},\n    onResults: () => {},\n    onResult: () => {},\n    onError: () => {}\n  }\n}\n\nexport default Geocoder\n"],"names":["VALID_POSITIONS","Geocoder","geocoder","cachedResult","initializeGeocoder","mapboxMap","_this","getMapboxMap","containerNode","getContainerNode","props","inputValue","render","getItemValue","onInit","position","options","accessToken","mapboxApiAccessToken","origin","zoom","flyTo","placeholder","proximity","trackProximity","collapsed","clearAndBlurOnEsc","clearOnBlur","bbox","types","countries","minLength","limit","language","filter","localGeocoder","reverseGeocode","enableEventLogging","marker","mapboxgl","MapboxGeocoder","subscribeEvents","appendChild","onAdd","addControl","find","_position","setInput","place_name","showClearIcon","_clearEl","style","display","mapRef","current","getMap","containerRef","on","handleClear","handleLoading","handleResults","handleResult","handleError","unsubscribeEvents","off","removeGeocoder","removeControl","onClear","event","onLoading","onResults","result","onViewportChange","onResult","center","properties","short_code","longitude","latitude","bboxExceptions","fr","name","us","ru","ca","getContainer","getBoundingClientRect","width","height","fitBounds","bounds","viewport","WebMercatorViewport","e","console","warn","transitionInterpolator","FlyToInterpolator","transitionDuration","_typeahead","selected","onError","componentDidMount","this","componentWillUnmount","componentDidUpdate","getGeocoder","PureComponent","propTypes","PropTypes","object","isRequired","func","string","number","bool","array","oneOf","defaultProps"],"mappings":"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"}